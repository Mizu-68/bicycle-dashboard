<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸å¯©è¡Œå‹•æ¤œçŸ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 20px;
    }

    #data-table td {
      font-weight: bold;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .top-controls {
      text-align: center;
      margin-bottom: 25px;
    }

    input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #bbb;
      border-radius: 6px;
      font-size: 16px;
    }

    .dashboard {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }

    /* ğŸ‘‡ å·¦:å³ = 40:60 ã«èª¿æ•´ */
    .left-panel {
      flex: 0.43;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px;
      min-width: 350px;
    }

    .right-panel {
      flex: 0.57;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
      min-width: 350px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      border-bottom: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }

    th {
      background: #f0f0f0;
      font-weight: 600;
    }

    tr:hover {
      background: #f9f9f9;
    }

    canvas {
      width: 100% !important;
      height: 380px !important;
    }

    /* å°ã•ã„ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã§å´©ã‚Œãªã„ã‚ˆã†ã« */
    @media (max-width: 900px) {
      .dashboard { flex-direction: column; }
      .left-panel, .right-panel { min-width: unset; }
    }
  </style>
</head>
<body>

  <h1>ğŸš² ä¸å¯©è¡Œå‹•æ¤œçŸ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <!-- æ—¥ä»˜é¸æŠ -->
  <div class="top-controls">
    <label>ğŸ“… æ—¥ä»˜ã‚’é¸æŠï¼š</label>
    <input type="date" id="datePicker">
  </div>

  <div class="dashboard">

    <!-- å·¦ï¼šè¡¨ -->
    <div class="left-panel">
      <h2>ğŸ“‹ æ¤œçŸ¥ãƒ‡ãƒ¼ã‚¿</h2>
      <table id="data-table">
        <thead>
          <tr>
            <th>æ—¥æ™‚</th>
            <th>ID</th>
            <th>å‹•ä½œ</th>
            <th>ã‚¾ãƒ¼ãƒ³</th>
            <th>ç§»å‹•</th>
            <th>æ™‚é–“(s)</th>
            <th>æ–¹å‘</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- å³ï¼šã‚°ãƒ©ãƒ•ç¾¤ -->
    <div class="right-panel">
      <h2 id="chart-title">ğŸ“ˆ æ¤œçŸ¥ç¨®é¡ã”ã¨ã®ä»¶æ•°ï¼ˆå…¨æœŸé–“ï¼‰</h2>
      <canvas id="dailyChart"></canvas>

      <!-- æ›œæ—¥åˆ¥ã‚°ãƒ©ãƒ•ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ã®ç©ã¿ä¸Šã’æ£’ï¼‰ -->
      <h3 id="weekday-title" style="margin-top:18px;">ğŸ“Š æ›œæ—¥åˆ¥ï¼ˆå…¨æœŸé–“ï¼‰</h3>
      <canvas id="weekdayChart"></canvas>
    </div>

  </div>

  <script>
    const API_URL = "https://z07k43psfl.execute-api.ap-northeast-1.amazonaws.com/";
    let allData = [];
    let chartAction = null;
    let chartWeekday = null;

    // è‰²ã¯æ—¢å­˜ã¨çµ±ä¸€
    const actionColors = {
      "STAYING": "rgba(54, 162, 235, 0.6)",
      "LOITERING": "rgba(255, 99, 132, 0.6)",
      "SQUATTING": "rgba(255, 206, 86, 0.6)",
      "BENDING": "rgba(75, 192, 192, 0.6)"
    };

    // ãƒ˜ãƒ«ãƒ‘ãƒ¼: yyy-mm-dd æ–‡å­—åˆ—
    function dateToYMD(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // æŒ‡å®šæ—¥ã®é€±ï¼ˆæ—¥æ›œå§‹ã¾ã‚Šï¼‰ã®é–‹å§‹æ—¥ï¼ˆDateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’è¿”ã™
    function weekStartSunday(date) {
      const d = new Date(date);
      const day = d.getDay(); // 0=æ—¥ ... 6=åœŸ
      const start = new Date(d);
      start.setDate(d.getDate() - day);
      start.setHours(0,0,0,0);
      return start;
    }

    // æŒ‡å®šæ—¥ã®é€±ï¼ˆæ—¥æ›œå§‹ã¾ã‚Šï¼‰ã«å«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºï¼ˆdateã¯ "YYYY-MM-DD" or Dateï¼‰
    function getDataForWeekContaining(dateStrOrDate) {
      const d = (typeof dateStrOrDate === "string") ? new Date(dateStrOrDate) : new Date(dateStrOrDate);
      const start = weekStartSunday(d);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      // compare by YYYY-MM-DD strings to avoid timezone pitfalls
      const s = dateToYMD(start);
      const e = dateToYMD(end);
      return allData.filter(item => {
        if (!item.timestamp) return false;
        const ymd = item.timestamp.split(" ")[0];
        return ymd >= s && ymd <= e;
      });
    }

    // ---- åˆå›ãƒ­ãƒ¼ãƒ‰ ----
    async function loadData() {
      try {
        const res = await fetch(API_URL);
        allData = await res.json();

        // è¡¨ï¼šæœ€æ–°20ä»¶
        renderTable(latest20());

        // ã‚°ãƒ©ãƒ•ï¼šå…¨æœŸé–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¥
        renderActionSummaryChart(allData, "ğŸ“ˆ æ¤œçŸ¥ç¨®é¡ã”ã¨ã®ä»¶æ•°ï¼ˆå…¨æœŸé–“ï¼‰");

        // æ›œæ—¥ã‚°ãƒ©ãƒ•ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å…¨æœŸé–“ï¼‰
        renderWeekdayStackedChart(allData, "ğŸ“Š æ›œæ—¥åˆ¥ï¼ˆå…¨æœŸé–“ï¼‰");

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸå€¤ï¼šæœ€æ–°æ—¥ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
        const dates = [...new Set(allData.map(d => d.timestamp && d.timestamp.split(" ")[0]).filter(Boolean))];
        if (dates.length > 0) {
          document.getElementById("datePicker").value = dates.sort().reverse()[0];
        } else {
          document.getElementById("datePicker").value = "";
        }

      } catch (e) {
        console.error("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
      }
    }

    // æœ€æ–°20ä»¶å–å¾—
    function latest20() {
      return allData
        .slice()
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 20);
    }

    // è¡¨æç”»ï¼ˆç©ºæ¬„ã¯ "" ã«ã—ã¦ã‚¹ãƒƒã‚­ãƒªï¼‰
    function renderTable(rows) {
      const tbody = document.querySelector("#data-table tbody");
      tbody.innerHTML = "";
      rows.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.timestamp ?? ""}</td>
          <td>${d.object_id ?? ""}</td>
          <td>${d.action ?? ""}</td>
          <td>${d.zone_id ?? ""}</td>
          <td>${d.zone_transition ?? ""}</td>
          <td>${d.duration_sec ? parseFloat(d.duration_sec).toFixed(1) : ""}</td>
          <td>${d.direction ?? ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ã‚µãƒãƒªï¼ˆæ—¢å­˜ã‚°ãƒ©ãƒ•ï¼‰
    function renderActionSummaryChart(rows, title) {
      const ctx = document.getElementById("dailyChart").getContext("2d");
      if (chartAction) chartAction.destroy();

      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
      const counts = {};
      rows.forEach(d => {
        counts[d.action] = (counts[d.action] || 0) + 1;
      });

      const labels = Object.keys(counts);
      const values = Object.values(counts);
      const bgColors = labels.map(a => actionColors[a] || "rgba(100,100,100,0.6)");

      document.getElementById("chart-title").innerText = title;

      chartAction = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "ä»¶æ•°",
            data: values,
            backgroundColor: bgColors
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true },
            datalabels: {
              anchor: "end",
              align: "top",
              formatter: v => v
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // æ›œæ—¥åˆ¥ç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ï¼ˆrowsã¯å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ç¾¤ï¼šå…¨æœŸé–“ or é€±ãƒ‡ãƒ¼ã‚¿ï¼‰
    function renderWeekdayStackedChart(rows, title) {
      const ctx = document.getElementById("weekdayChart").getContext("2d");
      if (chartWeekday) chartWeekday.destroy();

      // åˆæœŸåŒ–ï¼šæ›œæ—¥0(æ—¥)ã€œ6(åœŸ)
      const weekdays = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
      // actions set (ensure consistent order)
      const actions = Object.keys(actionColors);

      // build counts[action][weekdayIndex]
      const counts = {};
      actions.forEach(a => counts[a] = Array(7).fill(0));

      rows.forEach(d => {
        if (!d.timestamp || !d.action) return;
        const dt = new Date(d.timestamp);
        const wd = dt.getDay(); // 0=æ—¥
        if (!counts[d.action]) counts[d.action] = Array(7).fill(0);
        counts[d.action][wd] += 1;
      });

      // datasets in same action order
      const datasets = actions.map(a => ({
        label: a,
        data: counts[a],
        backgroundColor: actionColors[a] || "rgba(120,120,120,0.6)"
      }));

      // title for weekday chart
      document.getElementById("weekday-title").innerText = title;

      chartWeekday = new Chart(ctx, {
        type: "bar",
        data: {
          labels: weekdays, // æ—¥æ›œã‚¹ã‚¿ãƒ¼ãƒˆ
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: { mode: 'index', intersect: false },
            datalabels: {
              color: '#000',
              formatter: v => (v ? v : ''),
              anchor: 'center',
              align: 'center'
            }
          },
          scales: {
            x: { stacked: true },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById("datePicker").addEventListener("change", e => {
      const date = e.target.value;
      if (!date) {
        // ã‚¯ãƒªã‚¢ â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        renderTable(latest20());
        renderActionSummaryChart(allData, "ğŸ“ˆ æ¤œçŸ¥ç¨®é¡ã”ã¨ã®ä»¶æ•°ï¼ˆå…¨æœŸé–“ï¼‰");
        renderWeekdayStackedChart(allData, "ğŸ“Š æ›œæ—¥åˆ¥ï¼ˆå…¨æœŸé–“ï¼‰");
        return;
      }

      // é¸æŠæ—¥ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆè¡¨ã¯ãã®æ—¥ã®å…¨æ¤œçŸ¥ï¼‰
      const filteredDay = allData.filter(d => d.timestamp && d.timestamp.startsWith(date));
      filteredDay.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
      renderTable(filteredDay);

      // æ›œæ—¥ã‚°ãƒ©ãƒ•ã¯ã€Œé¸æŠæ—¥ã®é€±ï¼ˆæ—¥æ›œã€œåœŸæ›œï¼‰ã€ã§å†é›†è¨ˆ
      const weekRows = getDataForWeekContaining(date);
      renderWeekdayStackedChart(weekRows, `ğŸ“Š ${date} ã‚’å«ã‚€é€±ï¼ˆæ—¥â†’åœŸï¼‰ã®ä»¶æ•°`);
      // ãªãŠã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ã‚°ãƒ©ãƒ•ã¯é¸æŠæ—¥ã«é€£å‹•ã•ã›ã‚‹ï¼ˆãã®æ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…è¨³ã‚’è¡¨ç¤ºï¼‰
      renderActionSummaryChart(filteredDay, `ğŸ“ˆ ${date} ã®æ¤œçŸ¥ç¨®é¡åˆ¥ä»¶æ•°`);
    });

    // ChartDataLabels ã‚’ CDN ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰åˆæœŸåŒ–
    const dlScript = document.createElement("script");
    dlScript.src = "https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2";
    dlScript.onload = () => {
      // Register plugin (Chart.js 3+)
      Chart.register(ChartDataLabels);
      // Now load data
      loadData();
    };
    document.body.appendChild(dlScript);

  </script>

</body>
</html>
