<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸å¯©è¡Œå‹•æ¤œçŸ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .top-controls {
      text-align: center;
      margin-bottom: 25px;
    }

    input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #bbb;
      border-radius: 6px;
      font-size: 16px;
    }

    .dashboard {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: nowrap;
      gap: 20px;
    }

    /* å·¦ãƒ‘ãƒãƒ«ï¼ˆè¡¨ï¼‰ã‚’åºƒã‚ã«ã™ã‚‹ */
    .left-panel {
      flex: 1.2;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px;
      min-width: 350px;
    }

    .right-panel {
      flex: 1;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
      min-width: 350px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      border-bottom: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }

    th {
      background: #f0f0f0;
      font-weight: 600;
    }

    tr:hover {
      background: #f9f9f9;
    }

    canvas {
      width: 100% !important;
      height: 350px !important;
    }
  </style>
</head>
<body>

  <h1>ğŸš² ä¸å¯©è¡Œå‹•æ¤œçŸ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <!-- ğŸ”¥ æ—¥ä»˜é¸æŠã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="top-controls">
    <label>ğŸ“… æ—¥ä»˜ã‚’é¸æŠï¼š</label>
    <input type="date" id="datePicker">
  </div>

  <div class="dashboard">

    <!-- å·¦ãƒ‘ãƒãƒ«ï¼ˆæœ€æ–°20ä»¶ or é¸æŠæ—¥ã®è¡¨ï¼‰ -->
    <div class="left-panel">
      <h2>ğŸ“‹ æ¤œçŸ¥ãƒ‡ãƒ¼ã‚¿</h2>

      <table id="data-table">
        <thead>
          <tr>
            <th>æ—¥æ™‚</th>
            <th>ID</th>
            <th>å‹•ä½œ</th>
            <th>ã‚¾ãƒ¼ãƒ³</th>
            <th>ç§»å‹•</th>
            <th>æ™‚é–“(s)</th>
            <th>æ–¹å‘</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- å³ãƒ‘ãƒãƒ«ï¼ˆã‚°ãƒ©ãƒ•ï¼‰ -->
    <div class="right-panel">
      <h2 id="chart-title">ğŸ“ˆ æ¤œçŸ¥ç¨®é¡ã”ã¨ã®ä»¶æ•°ï¼ˆå…¨æœŸé–“ï¼‰</h2>
      <canvas id="dailyChart"></canvas>
    </div>

  </div>

  <script>
    const API_URL = "https://z07k43psfl.execute-api.ap-northeast-1.amazonaws.com/";
    let allData = [];
    let chart = null;

    // åˆå›ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    async function loadData() {
      try {
        const res = await fetch(API_URL);
        allData = await res.json();

        console.log("å–å¾—ãƒ‡ãƒ¼ã‚¿:", allData);

        // åˆå› â†’ æœ€æ–°20ä»¶è¡¨ç¤º
        renderTable(latest20());
        renderActionSummaryChart();

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸå€¤ã¯æœ€æ–°æ—¥
        const dates = [...new Set(allData.map(d => d.timestamp.split(" ")[0]))];
        const latest = dates.sort().reverse()[0];
        document.getElementById("datePicker").value = latest;

      } catch (e) {
        console.error("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
      }
    }

    // ğŸŸ¦ æœ€æ–°20ä»¶ã‚’å–å¾—ï¼ˆé™é †ï¼‰
    function latest20() {
      return allData
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 20);
    }

    // ğŸ”¶ è¡¨æ›´æ–°
    function renderTable(rows) {
      const tbody = document.querySelector("#data-table tbody");
      tbody.innerHTML = "";

      rows.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${d.timestamp}</td>
            <td>${d.object_id}</td>
            <td>${d.action}</td>
            <td>${d.zone_id || "-"}</td>
            <td>${d.zone_transition || "-"}</td>
            <td>${d.duration_sec ? parseFloat(d.duration_sec).toFixed(1) : "-"}</td>
            <td>${d.direction || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ğŸ”· å…¨æœŸé–“ã®ã€Œæ¤œçŸ¥ç¨®é¡ã”ã¨ã®ä»¶æ•°ã€æ£’ã‚°ãƒ©ãƒ•
    function renderActionSummaryChart() {
      const counts = {};

      allData.forEach(d => {
        counts[d.action] = (counts[d.action] || 0) + 1;
      });

      const actions = Object.keys(counts);
      const values = Object.values(counts);

      const ctx = document.getElementById("dailyChart").getContext("2d");

      if (chart) chart.destroy();

      document.getElementById("chart-title").innerText =
        "ğŸ“ˆ æ¤œçŸ¥ç¨®é¡ã”ã¨ã®ä»¶æ•°ï¼ˆå…¨æœŸé–“ï¼‰";

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: actions,
          datasets: [{
            label: "ä»¶æ•°",
            data: values,
            backgroundColor: [
              "rgba(255, 99, 132, 0.6)",
              "rgba(54, 162, 235, 0.6)",
              "rgba(255, 206, 86, 0.6)",
              "rgba(75, 192, 192, 0.6)"
            ]
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }   // â† å°æ•°ç‚¹ãªã—
            }
          }
        }
      });
    }

    // ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å¤‰æ›´ â†’ ãã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
    document.getElementById("datePicker").addEventListener("change", e => {
      const date = e.target.value;

      const filtered = allData.filter(d => d.timestamp.startsWith(date));
      filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      renderTable(filtered);

      renderDailyCountChart(filtered, date);
    });

    // ğŸ”· é¸æŠæ—¥ã®ä»¶æ•°ã‚°ãƒ©ãƒ•
    function renderDailyCountChart(rows, date) {
      const ctx = document.getElementById("dailyChart").getContext("2d");

      if (chart) chart.destroy();

      document.getElementById("chart-title").innerText =
        `ğŸ“ˆ ${date} ã®æ¤œçŸ¥ä»¶æ•°`;

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: [date],
          datasets: [{
            label: "ä»¶æ•°",
            data: [rows.length],
            backgroundColor: "rgba(54, 162, 235, 0.6)"
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }  // å°æ•°ç‚¹ãªã—
            }
          }
        }
      });
    }

    loadData();
  </script>
</body>
</html>
