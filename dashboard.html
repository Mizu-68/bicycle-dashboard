<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä¸å¯©è¡Œå‹•æ¤œçŸ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f8fafc;
      margin: 20px;
      color: #333;
    }
    h1 { text-align: center; color: #0078D7; }
    canvas { max-width: 900px; margin: 40px auto; display: block; }
    table {
      border-collapse: collapse;
      width: 95%;
      margin: 30px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px 15px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #0078D7;
      color: white;
    }
    tr:hover { background: #f0f8ff; }
  </style>
</head>
<body>

  <h1>ğŸš¨ ä¸å¯©è¡Œå‹•æ¤œçŸ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <canvas id="chart"></canvas>

  <table id="logTable">
    <thead>
      <tr>
        <th>æ—¥æ™‚</th>
        <th>Object ID</th>
        <th>å‹•ä½œ</th>
        <th>ã‚¾ãƒ¼ãƒ³</th>
        <th>æ–¹å‘</th>
        <th>ã‚¾ãƒ¼ãƒ³ç§»å‹•</th>
        <th>ç¶™ç¶šæ™‚é–“(s)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = "https://z07k43psfl.execute-api.ap-northeast-1.amazonaws.com".replace(/\/$/, "");

    async function loadData() {
      try {
        console.log("ğŸŒ APIã¸æ¥ç¶šä¸­:", API_URL);
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${res.status}`);
        const data = await res.json();
        console.log("ğŸ“¦ APIã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:", data);

        if (!Array.isArray(data)) {
          console.warn("âš ï¸ ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:", data);
          return;
        }

        // ğŸ—“ï¸ æ—¥ã”ã¨ã®ä»¶æ•°é›†è¨ˆ
        const counts = {};
        data.forEach(item => {
          if (!item.timestamp) return;
          const date = item.timestamp.split(" ")[0];
          counts[date] = (counts[date] || 0) + 1;
        });

        // ğŸ“Š æ£’ã‚°ãƒ©ãƒ•æç”»
        const ctx = document.getElementById('chart');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(counts),
            datasets: [{
              label: 'æ¤œçŸ¥ä»¶æ•°ï¼ˆæ—¥ã”ã¨ï¼‰',
              data: Object.values(counts),
              backgroundColor: 'rgba(0, 120, 215, 0.7)'
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
          }
        });

        // ğŸ“‹ æ¤œçŸ¥ãƒ­ã‚°ä¸€è¦§è¡¨ç¤º
        const tbody = document.querySelector("#logTable tbody");
        tbody.innerHTML = "";
        data.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));

        data.forEach(d => {
          const tr = document.createElement("tr");

          // direction ãŒæ•°å€¤æ–‡å­—åˆ—ãªã‚‰ã€Œâ†’ã€ã€Œâ†ã€ã«å¤‰æ›
          let directionText = d.direction || "-";
          if (directionText === "1" || directionText === "+1") directionText = "â†’";
          else if (directionText === "-1") directionText = "â†";

          tr.innerHTML = `
            <td>${d.timestamp || '-'}</td>
            <td>${d.object_id || '-'}</td>
            <td>${d.action || '-'}</td>
            <td>${d.zone_id || '-'}</td>
            <td>${directionText}</td>
            <td>${d.zone_transition || '-'}</td>
            <td>${d.duration_sec ? parseFloat(d.duration_sec).toFixed(1) : '-'}</td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      }
    }

    loadData();
  </script>

</body>
</html>
