<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸å¯©è¡Œå‹•æ¤œçŸ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 20px;
    }
    #data-table td { font-weight: bold; }
    h1 { text-align: center; margin-bottom: 20px; color: #333; }
    .top-controls { text-align: center; margin-bottom: 25px; }
    input[type="date"] {
      padding: 8px 12px; border: 1px solid #bbb; border-radius: 6px; font-size: 16px;
    }
    .dashboard { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; }
    .left-panel {
      flex: 0.43; background: white; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px; min-width: 350px;
    }
    .right-panel {
      flex: 0.57; background: white; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px; min-width: 350px;
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background: #f0f0f0; font-weight: 600; }
    tr:hover { background: #f9f9f9; }
    canvas { width: 100% !important; height: 330px !important; }
    .subchart { margin-top: 35px; }
  </style>
</head>
<body>
  <h1>ğŸš² ä¸å¯©è¡Œå‹•æ¤œçŸ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <div class="top-controls">
    <label>ğŸ“… æ—¥ä»˜ã‚’é¸æŠï¼š</label>
    <input type="date" id="datePicker">
  </div>

  <div class="dashboard">
    <div class="left-panel">
      <h2>ğŸ“‹ æ¤œçŸ¥ãƒ‡ãƒ¼ã‚¿</h2>
      <table id="data-table">
        <thead>
          <tr>
            <th>æ—¥æ™‚</th><th>ID</th><th>å‹•ä½œ</th><th>ã‚¾ãƒ¼ãƒ³</th>
            <th>ç§»å‹•</th><th>æ™‚é–“(s)</th><th>æ–¹å‘</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="right-panel">
      <h2 id="chart-title">ğŸ“ˆ æ¤œçŸ¥ç¨®é¡ã”ã¨ã®ä»¶æ•°ï¼ˆå…¨æœŸé–“ï¼‰</h2>
      <canvas id="dailyChart"></canvas>

      <h2 class="subchart">ğŸ“Š æ›œæ—¥åˆ¥æ¤œçŸ¥æ•°</h2>
      <canvas id="weekdayChart"></canvas>

      <h2 class="subchart">â± æ™‚é–“å¸¯åˆ¥æ¤œçŸ¥æ•°</h2>
      <canvas id="timeChart"></canvas>
    </div>
  </div>

<script>
const API_URL = "https://z07k43psfl.execute-api.ap-northeast-1.amazonaws.com/";
let allData = [];
let chart = null, weekdayChart = null, timeChart = null;

const actionColors = {
  "STAYING": "rgba(54,162,235,0.6)",
  "LOITERING": "rgba(255,99,132,0.6)",
  "SQUATTING": "rgba(255,206,86,0.6)",
  "BENDING": "rgba(75,192,192,0.6)"
};

async function loadData() {
  const res = await fetch(API_URL);
  allData = await res.json();
  renderTable(latest20());
  renderActionSummaryChart(allData, "ğŸ“ˆ æ¤œçŸ¥ç¨®é¡ã”ã¨ã®ä»¶æ•°ï¼ˆå…¨æœŸé–“ï¼‰");
  renderWeekdayChart(allData);
  renderTimeChart(allData);
}

function latest20() {
  return allData.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).slice(0,20);
}

function renderTable(rows){
  const tbody=document.querySelector("#data-table tbody");
  tbody.innerHTML="";
  rows.forEach(d=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${d.timestamp}</td><td>${d.object_id}</td><td>${d.action}</td>
    <td>${d.zone_id??""}</td><td>${d.zone_transition??""}</td>
    <td>${d.duration_sec?parseFloat(d.duration_sec).toFixed(1):""}</td>
    <td>${d.direction??""}</td>`;
    tbody.appendChild(tr);
  });
}

function renderActionSummaryChart(rows,title){
  const ctx=document.getElementById("dailyChart").getContext("2d");
  if(chart) chart.destroy();

  const counts={};
  rows.forEach(d=>counts[d.action]=(counts[d.action]||0)+1);

  chart=new Chart(ctx,{
    type:"bar",
    data:{ labels:Object.keys(counts), datasets:[{
      label:"ä»¶æ•°", data:Object.values(counts), backgroundColor:Object.keys(counts).map(a=>actionColors[a])
    }]},
    options:{ responsive:true, plugins:{ legend:{display:false}, datalabels:{anchor:"end",align:"top"} },
      scales:{ y:{beginAtZero:true,ticks:{stepSize:1}} } }, plugins:[ChartDataLabels]
  });
  document.getElementById("chart-title").innerText=title;
}

function renderWeekdayChart(rows){
  const ctx=document.getElementById("weekdayChart").getContext("2d");
  if(weekdayChart) weekdayChart.destroy();

  const days=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  const counts={}; rows.forEach(d=>{
    const wd=new Date(d.timestamp).getDay();
    const key=`${wd}-${d.action}`;
    counts[key]=(counts[key]||0)+1;
  });

  const datasets=[];
  Object.keys(actionColors).forEach(a=>{
    const data=[];
    for(let i=0;i<7;i++){ data.push(counts[`${i}-${a}`]||0); }
    datasets.push({ label:a, data, backgroundColor:actionColors[a] });
  });

  weekdayChart=new Chart(ctx,{
    type:"bar",
    data:{ labels:days, datasets },
    options:{ responsive:true, plugins:{ datalabels:{anchor:"end",align:"top"} },
      scales:{ y:{beginAtZero:true,ticks:{stepSize:1}} } }, plugins:[ChartDataLabels]
  });
}

function renderTimeChart(rows){
  const ctx=document.getElementById("timeChart").getContext("2d");
  if(timeChart) timeChart.destroy();

  const labels=["0-3","3-6","6-9","9-12","12-15","15-18","18-21","21-24"];

  const counts={}; rows.forEach(d=>{
    const h=new Date(d.timestamp).getHours();
    const bin=Math.floor(h/3);
    const key=`${bin}-${d.action}`;
    counts[key]=(counts[key]||0)+1;
  });

  const datasets=[];
  Object.keys(actionColors).forEach(a=>{
    const data=[];
    for(let i=0;i<8;i++) data.push(counts[`${i}-${a}`]||0);
    datasets.push({ label:a, data, backgroundColor:actionColors[a] });
  });

  timeChart=new Chart(ctx,{
    type:"bar",
    data:{ labels, datasets },
    options:{ responsive:true, plugins:{ datalabels:{anchor:"end",align:"top"} },
      scales:{ y:{beginAtZero:true,ticks:{stepSize:1}} } }, plugins:[ChartDataLabels]
  });
}

document.getElementById("datePicker").addEventListener("change", e=>{
  const date=e.target.value;
  if(!date){ renderTable(latest20()); renderActionSummaryChart(allData,"ğŸ“ˆ æ¤œçŸ¥ç¨®é¡ã”ã¨ã®ä»¶æ•°ï¼ˆå…¨æœŸé–“ï¼‰"); renderWeekdayChart(allData); renderTimeChart(allData); return; }
  const filtered=allData.filter(d=>d.timestamp.startsWith(date));
  renderTable(filtered);
  renderActionSummaryChart(filtered,`ğŸ“ˆ ${date} ã®æ¤œçŸ¥ç¨®é¡åˆ¥ä»¶æ•°`);
  renderWeekdayChart(filtered);
  renderTimeChart(filtered);
});

loadData();
</script>

</body>
</html>
